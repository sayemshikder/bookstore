<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: IntelligentUtils
  
    &mdash; Documentation by YARD 0.9.9
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "IntelligentUtils";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (I)</a> &raquo;
    
    
    <span class="title">IntelligentUtils</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: IntelligentUtils
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/filestack/utils/utils.rb</dd>
  </dl>
  
</div>








  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#bad_state-instance_method" title="#bad_state (instance method)">#<strong>bad_state</strong>(state)  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if state is in error state or has reached maximum retries.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#change_offset-instance_method" title="#change_offset (instance method)">#<strong>change_offset</strong>(working_offset, state)  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return current working offest if state has not tried it.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#chunk_job-instance_method" title="#chunk_job (instance method)">#<strong>chunk_job</strong>(job, state, apikey, filename, filepath, filesize, start_response)  &#x21d2; Dict </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Chunk a specific job into offests.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_intelligent_generator-instance_method" title="#create_intelligent_generator (instance method)">#<strong>create_intelligent_generator</strong>(jobs)  &#x21d2; Fiber </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a generator of part jobs.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_upload_job_chunks-instance_method" title="#create_upload_job_chunks (instance method)">#<strong>create_upload_job_chunks</strong>(jobs, state, apikey, filename, filepath, filesize, start_response)  &#x21d2; Array </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Loop and run chunks for each offset.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_generator_batch-instance_method" title="#get_generator_batch (instance method)">#<strong>get_generator_batch</strong>(generator)  &#x21d2; Array </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates a batch given a Fiber.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run_intelligent_upload_flow-instance_method" title="#run_intelligent_upload_flow (instance method)">#<strong>run_intelligent_upload_flow</strong>(jobs, state)  &#x21d2; Array </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Runs the intelligent upload flow, from start to finish.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run_intelligent_uploads-instance_method" title="#run_intelligent_uploads (instance method)">#<strong>run_intelligent_uploads</strong>(part, state)  &#x21d2; IntelligentState </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Send a job&#39;s chunks in parallel and commit.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#upload_chunk_intelligently-instance_method" title="#upload_chunk_intelligently (instance method)">#<strong>upload_chunk_intelligently</strong>(job, state, apikey, filepath, options)  &#x21d2; Unirest::Response </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Upload a single chunk.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="bad_state-instance_method">
  
    #<strong>bad_state</strong>(state)  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check if state is in error state or has reached maximum retries</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An IntelligentState object</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


170
171
172</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 170</span>

<span class='kw'>def</span> <span class='id identifier rubyid_bad_state'>bad_state</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
  <span class='op'>!</span><span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_ok'>ok</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_alive?'>alive?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="change_offset-instance_method">
  
    #<strong>change_offset</strong>(working_offset, state)  &#x21d2; <tt>Integer</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return current working offest if state has not tried it. Otherwise, return
the next offset of the state</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>working_offset</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The current offset</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An IntelligentState object</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


182
183
184
185
186
187
188</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 182</span>

<span class='kw'>def</span> <span class='id identifier rubyid_change_offset'>change_offset</span><span class='lparen'>(</span><span class='id identifier rubyid_working_offset'>working_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_offset'>offset</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_working_offset'>working_offset</span>
    <span class='id identifier rubyid_working_offset'>working_offset</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_offset'>offset</span> <span class='op'>=</span> <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_next_offset'>next_offset</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="chunk_job-instance_method">
  
    #<strong>chunk_job</strong>(job, state, apikey, filename, filepath, filesize, start_response)  &#x21d2; <tt>Dict</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Chunk a specific job into offests</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>job</span>
      
      
        <span class='type'>(<tt>Dict</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Dictionary with all job options</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An IntelligentState object</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>apikey</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Filestack API key</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filename</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Name of incoming file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filepath</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Local path to the file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filesize</span>
      
      
        <span class='type'>(<tt>Int</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Size of incoming file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>start_response</span>
      
      
        <span class='type'>(<tt>Unirest::Response</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Response body from multipart_start</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Dict</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 272</span>

<span class='kw'>def</span> <span class='id identifier rubyid_chunk_job'>chunk_job</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_apikey'>apikey</span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_filepath'>filepath</span><span class='comma'>,</span> <span class='id identifier rubyid_filesize'>filesize</span><span class='comma'>,</span> <span class='id identifier rubyid_start_response'>start_response</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_offset'>offset</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_seek_point'>seek_point</span> <span class='op'>=</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:seek</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_chunk_list'>chunk_list</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='kw'>while</span> <span class='lparen'>(</span><span class='id identifier rubyid_offset'>offset</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="FilestackConfig.html" title="FilestackConfig (class)">FilestackConfig</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="FilestackConfig.html#DEFAULT_CHUNK_SIZE-constant" title="FilestackConfig::DEFAULT_CHUNK_SIZE (constant)">DEFAULT_CHUNK_SIZE</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_seek_point'>seek_point</span> <span class='op'>+</span> <span class='id identifier rubyid_offset'>offset</span><span class='rparen'>)</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_filesize'>filesize</span>
    <span class='id identifier rubyid_chunk_list'>chunk_list</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span>
      <span class='label'>seek:</span> <span class='id identifier rubyid_seek_point'>seek_point</span><span class='comma'>,</span>
      <span class='label'>filepath:</span> <span class='id identifier rubyid_filepath'>filepath</span><span class='comma'>,</span>
      <span class='label'>filename:</span> <span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span>
      <span class='label'>apikey:</span> <span class='id identifier rubyid_apikey'>apikey</span><span class='comma'>,</span>
      <span class='label'>part:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:part</span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>size:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:size</span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>uri:</span> <span class='id identifier rubyid_start_response'>start_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uri</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>region:</span> <span class='id identifier rubyid_start_response'>start_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>region</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>upload_id:</span> <span class='id identifier rubyid_start_response'>start_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>upload_id</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>location_url:</span> <span class='id identifier rubyid_start_response'>start_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>location_url</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>store_location:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:store_location</span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='label'>offset:</span> <span class='id identifier rubyid_offset'>offset</span>
    <span class='rparen'>)</span>
    <span class='id identifier rubyid_offset'>offset</span> <span class='op'>+=</span> <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_offset'>offset</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_chunk_list'>chunk_list</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create_intelligent_generator-instance_method">
  
    #<strong>create_intelligent_generator</strong>(jobs)  &#x21d2; <tt>Fiber</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a generator of part jobs</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>jobs</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A list of file parts</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Fiber</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


229
230
231
232
233
234
235
236
237</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 229</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create_intelligent_generator'>create_intelligent_generator</span><span class='lparen'>(</span><span class='id identifier rubyid_jobs'>jobs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_jobs_gen'>jobs_gen</span> <span class='op'>=</span> <span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_lazy'>lazy</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span>
  <span class='const'>Fiber</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
    <span class='lparen'>(</span><span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='op'>-</span><span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span> 
      <span class='const'>Fiber</span><span class='period'>.</span><span class='id identifier rubyid_yield'>yield</span> <span class='id identifier rubyid_jobs_gen'>jobs_gen</span><span class='period'>.</span><span class='id identifier rubyid_next'>next</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_jobs_gen'>jobs_gen</span><span class='period'>.</span><span class='id identifier rubyid_next'>next</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create_upload_job_chunks-instance_method">
  
    #<strong>create_upload_job_chunks</strong>(jobs, state, apikey, filename, filepath, filesize, start_response)  &#x21d2; <tt>Array</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Loop and run chunks for each offset</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>jobs</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A list of file parts</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An IntelligentState object</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>apikey</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Filestack API key</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filename</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Name of incoming file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filepath</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Local path to the file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filesize</span>
      
      
        <span class='type'>(<tt>Int</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Size of incoming file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>start_response</span>
      
      
        <span class='type'>(<tt>Unirest::Response</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Response body from multipart_start</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


251
252
253
254
255
256
257
258</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 251</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create_upload_job_chunks'>create_upload_job_chunks</span><span class='lparen'>(</span><span class='id identifier rubyid_jobs'>jobs</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_apikey'>apikey</span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_filepath'>filepath</span><span class='comma'>,</span> <span class='id identifier rubyid_filesize'>filesize</span><span class='comma'>,</span> <span class='id identifier rubyid_start_response'>start_response</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_job'>job</span><span class='op'>|</span>
    <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:chunks</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_chunk_job'><span class='object_link'><a href="#chunk_job-instance_method" title="IntelligentUtils#chunk_job (method)">chunk_job</a></span></span><span class='lparen'>(</span>
      <span class='id identifier rubyid_job'>job</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_apikey'>apikey</span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_filepath'>filepath</span><span class='comma'>,</span> <span class='id identifier rubyid_filesize'>filesize</span><span class='comma'>,</span> <span class='id identifier rubyid_start_response'>start_response</span>
    <span class='rparen'>)</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_jobs'>jobs</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_generator_batch-instance_method">
  
    #<strong>get_generator_batch</strong>(generator)  &#x21d2; <tt>Array</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates a batch given a Fiber</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>generator</span>
      
      
        <span class='type'>(<tt>Fiber</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A living Fiber object</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


156
157
158
159
160
161
162</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 156</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_generator_batch'>get_generator_batch</span><span class='lparen'>(</span><span class='id identifier rubyid_generator'>generator</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_batch'>batch</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='int'>4</span><span class='period'>.</span><span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_batch'>batch</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_generator'>generator</span><span class='period'>.</span><span class='id identifier rubyid_resume'>resume</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_generator'>generator</span><span class='period'>.</span><span class='id identifier rubyid_alive?'>alive?</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_batch'>batch</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run_intelligent_upload_flow-instance_method">
  
    #<strong>run_intelligent_upload_flow</strong>(jobs, state)  &#x21d2; <tt>Array</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Runs the intelligent upload flow, from start to finish</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>jobs</span>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A list of file parts</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An IntelligentState object</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 196</span>

<span class='kw'>def</span> <span class='id identifier rubyid_run_intelligent_upload_flow'>run_intelligent_upload_flow</span><span class='lparen'>(</span><span class='id identifier rubyid_jobs'>jobs</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_bar'>bar</span> <span class='op'>=</span> <span class='const'>ProgressBar</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_jobs'>jobs</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_generator'>generator</span> <span class='op'>=</span> <span class='id identifier rubyid_create_intelligent_generator'><span class='object_link'><a href="#create_intelligent_generator-instance_method" title="IntelligentUtils#create_intelligent_generator (method)">create_intelligent_generator</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_jobs'>jobs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_working_offset'>working_offset</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="FilestackConfig.html" title="FilestackConfig (class)">FilestackConfig</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="FilestackConfig.html#DEFAULT_OFFSET_SIZE-constant" title="FilestackConfig::DEFAULT_OFFSET_SIZE (constant)">DEFAULT_OFFSET_SIZE</a></span></span>
  <span class='kw'>while</span> <span class='id identifier rubyid_generator'>generator</span><span class='period'>.</span><span class='id identifier rubyid_alive?'>alive?</span>
    <span class='id identifier rubyid_batch'>batch</span> <span class='op'>=</span> <span class='id identifier rubyid_get_generator_batch'><span class='object_link'><a href="#get_generator_batch-instance_method" title="IntelligentUtils#get_generator_batch (method)">get_generator_batch</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_generator'>generator</span><span class='rparen'>)</span>   
    <span class='comment'># run parts   
</span>    <span class='const'>Parallel</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='id identifier rubyid_batch'>batch</span><span class='comma'>,</span> <span class='label'>in_threads:</span> <span class='int'>4</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_part'>part</span><span class='op'>|</span>
      <span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='id identifier rubyid_run_intelligent_uploads'><span class='object_link'><a href="#run_intelligent_uploads-instance_method" title="IntelligentUtils#run_intelligent_uploads (method)">run_intelligent_uploads</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_part'>part</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
      <span class='comment'># condition: a chunk has failed but we have not reached the maximum retries
</span>      <span class='kw'>while</span> <span class='id identifier rubyid_bad_state'><span class='object_link'><a href="#bad_state-instance_method" title="IntelligentUtils#bad_state (method)">bad_state</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
        <span class='comment'># condition: timeout to S3, requiring offset size to be changed
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_error_type'>error_type</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>S3_NETWORK</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='int'>5</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_offset'>offset</span> <span class='op'>=</span> <span class='id identifier rubyid_working_offset'>working_offset</span> <span class='op'>=</span> <span class='id identifier rubyid_change_offset'><span class='object_link'><a href="#change_offset-instance_method" title="IntelligentUtils#change_offset (method)">change_offset</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_working_offset'>working_offset</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
        <span class='comment'># condition: timeout to backend, requiring only backoff
</span>        <span class='kw'>elsif</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>S3_SERVER</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BACKEND_SERVER</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_error_type'>error_type</span>
          <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_backoff'>backoff</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_add_retry'>add_retry</span>
        <span class='id identifier rubyid_state'>state</span> <span class='op'>=</span> <span class='id identifier rubyid_run_intelligent_uploads'><span class='object_link'><a href="#run_intelligent_uploads-instance_method" title="IntelligentUtils#run_intelligent_uploads (method)">run_intelligent_uploads</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_part'>part</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Upload has failed. Please try again later.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_ok'>ok</span>
      <span class='id identifier rubyid_bar'>bar</span><span class='period'>.</span><span class='id identifier rubyid_increment!'>increment!</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run_intelligent_uploads-instance_method">
  
    #<strong>run_intelligent_uploads</strong>(part, state)  &#x21d2; <tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Send a job&#39;s chunks in parallel and commit</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>part</span>
      
      
        <span class='type'>(<tt>Dict</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>A dictionary representing the information for a single part</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An IntelligentState object</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 303</span>

<span class='kw'>def</span> <span class='id identifier rubyid_run_intelligent_uploads'>run_intelligent_uploads</span><span class='lparen'>(</span><span class='id identifier rubyid_part'>part</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_failed'>failed</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_chunks'>chunks</span> <span class='op'>=</span> <span class='id identifier rubyid_chunk_job'><span class='object_link'><a href="#chunk_job-instance_method" title="IntelligentUtils#chunk_job (method)">chunk_job</a></span></span><span class='lparen'>(</span>
    <span class='id identifier rubyid_part'>part</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:apikey</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:filename</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:filepath</span><span class='rbracket'>]</span><span class='comma'>,</span> 
    <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:filesize</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:start_response</span><span class='rbracket'>]</span>
  <span class='rparen'>)</span>
  <span class='const'>Parallel</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='id identifier rubyid_chunks'>chunks</span><span class='comma'>,</span> <span class='label'>in_threads:</span> <span class='int'>3</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_chunk'>chunk</span><span class='op'>|</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_upload_chunk_intelligently'><span class='object_link'><a href="#upload_chunk_intelligently-instance_method" title="IntelligentUtils#upload_chunk_intelligently (method)">upload_chunk_intelligently</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_chunk'>chunk</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:apikey</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:filepath</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:options</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_error_type'>error_type</span> <span class='op'>=</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
      <span class='id identifier rubyid_failed'>failed</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='const'>Parallel</span><span class='op'>::</span><span class='const'>Kill</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_failed'>failed</span>
    <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_ok'>ok</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_state'>state</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_ok'>ok</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_commit_params'>commit_params</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>apikey:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:apikey</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>uri:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>region:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:region</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>upload_id:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:upload_id</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>size:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:filesize</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>part:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:part</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>location_url:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:location_url</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>store_location:</span> <span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:store_location</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>file:</span> <span class='const'>Tempfile</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_part'>part</span><span class='lbracket'>[</span><span class='symbol'>:filename</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='const'>Unirest</span><span class='period'>.</span><span class='id identifier rubyid_post'>post</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="FilestackConfig.html" title="FilestackConfig (class)">FilestackConfig</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="FilestackConfig.html#MULTIPART_COMMIT_URL-constant" title="FilestackConfig::MULTIPART_COMMIT_URL (constant)">MULTIPART_COMMIT_URL</a></span></span><span class='comma'>,</span> <span class='label'>parameters:</span> <span class='id identifier rubyid_commit_params'>commit_params</span><span class='comma'>,</span>
                                                                 <span class='label'>headers:</span> <span class='const'><span class='object_link'><a href="FilestackConfig.html" title="FilestackConfig (class)">FilestackConfig</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="FilestackConfig.html#HEADERS-constant" title="FilestackConfig::HEADERS (constant)">HEADERS</a></span></span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span> <span class='op'>==</span> <span class='int'>200</span>
    <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_reset'>reset</span>
  <span class='kw'>else</span> 
    <span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_ok'>ok</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_state'>state</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="upload_chunk_intelligently-instance_method">
  
    #<strong>upload_chunk_intelligently</strong>(job, state, apikey, filepath, options)  &#x21d2; <tt>Unirest::Response</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Upload a single chunk</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>job</span>
      
      
        <span class='type'>(<tt>Dict</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Dictionary with all job options</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>state</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="IntelligentState.html" title="IntelligentState (class)">IntelligentState</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>An IntelligentState object</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>apikey</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Filestack API key</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filename</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Name of incoming file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>filepath</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Local path to the file</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>User-defined options for multipart uploads</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Unirest::Response</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/filestack/utils/utils.rb', line 357</span>

<span class='kw'>def</span> <span class='id identifier rubyid_upload_chunk_intelligently'>upload_chunk_intelligently</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='comma'>,</span> <span class='id identifier rubyid_state'>state</span><span class='comma'>,</span> <span class='id identifier rubyid_apikey'>apikey</span><span class='comma'>,</span> <span class='id identifier rubyid_filepath'>filepath</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_filepath'>filepath</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_seek'>seek</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:seek</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:offset</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_chunk'>chunk</span> <span class='op'>=</span> <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_state'>state</span><span class='period'>.</span><span class='id identifier rubyid_offset'>offset</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_md5'>md5</span> <span class='op'>=</span> <span class='const'>Digest</span><span class='op'>::</span><span class='const'>MD5</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_md5'>md5</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_chunk'>chunk</span>  
  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>apikey:</span> <span class='id identifier rubyid_apikey'>apikey</span><span class='comma'>,</span>
    <span class='label'>part:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:part</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>size:</span> <span class='id identifier rubyid_chunk'>chunk</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='comma'>,</span>
    <span class='label'>md5:</span> <span class='id identifier rubyid_md5'>md5</span><span class='period'>.</span><span class='id identifier rubyid_base64digest'>base64digest</span><span class='comma'>,</span>
    <span class='label'>uri:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>region:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:region</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>upload_id:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:upload_id</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>store_location:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:store_location</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>offset:</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:offset</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='label'>file:</span> <span class='const'>Tempfile</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:filename</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>multipart</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>true</span><span class='tstring_end'>&#39;</span></span>
  <span class='rbrace'>}</span>

  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span>
  <span class='id identifier rubyid_fs_response'>fs_response</span> <span class='op'>=</span> <span class='const'>Unirest</span><span class='period'>.</span><span class='id identifier rubyid_post'>post</span><span class='lparen'>(</span>
    <span class='const'><span class='object_link'><a href="FilestackConfig.html" title="FilestackConfig (class)">FilestackConfig</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="FilestackConfig.html#MULTIPART_UPLOAD_URL-constant" title="FilestackConfig::MULTIPART_UPLOAD_URL (constant)">MULTIPART_UPLOAD_URL</a></span></span><span class='comma'>,</span> <span class='label'>parameters:</span> <span class='id identifier rubyid_data'>data</span><span class='comma'>,</span>
                                           <span class='label'>headers:</span> <span class='const'><span class='object_link'><a href="FilestackConfig.html" title="FilestackConfig (class)">FilestackConfig</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="FilestackConfig.html#HEADERS-constant" title="FilestackConfig::HEADERS (constant)">HEADERS</a></span></span>
  <span class='rparen'>)</span>
  <span class='comment'># POST to multipart/upload
</span>  <span class='kw'>begin</span> 
    <span class='kw'>unless</span> <span class='id identifier rubyid_fs_response'>fs_response</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span> <span class='op'>==</span> <span class='int'>200</span>
      <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>400</span><span class='comma'>,</span> <span class='int'>403</span><span class='comma'>,</span> <span class='int'>404</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_fs_response'>fs_response</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>FAILURE</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>else</span> 
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BACKEND_SERVER</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

  <span class='kw'>rescue</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BACKEND_NETWORK</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_fs_response'>fs_response</span> <span class='op'>=</span> <span class='id identifier rubyid_fs_response'>fs_response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span>
  
  <span class='comment'># PUT to S3
</span>  <span class='kw'>begin</span> 
    <span class='id identifier rubyid_amazon_response'>amazon_response</span> <span class='op'>=</span> <span class='const'>Unirest</span><span class='period'>.</span><span class='id identifier rubyid_put'>put</span><span class='lparen'>(</span>
      <span class='id identifier rubyid_fs_response'>fs_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>url</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='id identifier rubyid_fs_response'>fs_response</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>headers</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>parameters:</span> <span class='id identifier rubyid_chunk'>chunk</span>
    <span class='rparen'>)</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_amazon_response'>amazon_response</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span> <span class='op'>==</span> <span class='int'>200</span>
      <span class='kw'>if</span> <span class='lbracket'>[</span><span class='int'>400</span><span class='comma'>,</span> <span class='int'>403</span><span class='comma'>,</span> <span class='int'>404</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_amazon_response'>amazon_response</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>FAILURE</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>else</span> 
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>S3_SERVER</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  
  <span class='kw'>rescue</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>S3_NETWORK</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_amazon_response'>amazon_response</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu Aug 17 10:04:38 2017 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.9 (ruby-2.4.0).
</div>

    </div>
  </body>
</html>